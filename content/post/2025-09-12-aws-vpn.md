---
title: "Establishing IPsec VPN Connectivity Between AWS EC2 and LoT Gateway Using StrongSwan"
date: 2025-09-12T10:01:01+09:00
draft: false          
type: "post"
categories:
  - Tech Notes
tags:
  - AWS
  - VPN
  - IoTGW
  - IPv4
author: "coherence"
---

## Introduction

In this guide, I'll walk through the complete process of setting up an IPsec VPN tunnel between an AWS EC2 instance and a LoT Gateway using StrongSwan. This solution enables remote access to the LoT Gateway's management interface and facilitates log retrieval through a secure VPN connection.

## Architecture Overview
 ![Network Diagram](/images/diagram.png)

## Prerequisites
- AWS EC2 instance with Elastic IP
- LoT Gateway with cellular connectivity
- Basic knowledge of Linux command line
- SSH access to EC2 instance

## Launch EC2 Instance
Configure security groups to allow:
- SSH (TCP 22)
- IKE (UDP 500)
- NAT-T (UDP 4500)
- ESP (IP Protocol 50)

## Assign Elastic IP
Allocate and associate Elastic IP to EC2 instance
Note: You'll need this for consistent VPN endpoint

## Install StrongSwan on EC2
```bash
# For Amazon Linux 2023
sudo dnf update -y
sudo dnf install strongswan strongswan-swanctl -y

# Enable and start service
sudo systemctl enable strongswan
sudo systemctl start strongswan

sudo systemctl status strongswan
sudo swanctl --version
```

## StrongSwan Configuration
```bash
# Create Configuration Directory
sudo mkdir -p /etc/swanctl/conf.d

# Main Configuration File
sudo nano /etc/swanctl/swanctl.conf
```

```conf
# Connection Configuration
connections {
    lotgw-vpn {
        # EC2 public IP address
        local_addrs = your EC2 address
        
        # Accept connections from any remote IP (dynamic mobile IP)
        remote_addrs = 0.0.0.0/0,::/0 # can accept any connection request

        # Local authentication
        local {
            auth = psk
            id = vpns
        }
        
        # Remote authentication
        remote {
            auth = psk
            id = lotgW
        }

        # VPN tunnel configuration
        children {
            net-net {
                # Route all traffic through VPN
                local_ts = your vpn network
                remote_ts = your lotgW network
                
                # Tunnel settings
                mode = tunnel
                start_action = none
                
                # Encryption proposals
                esp_proposals = aes128-sha256-modp2048
            }
        }

        # IKE settings
        version = 2
        mobike = yes
        proposals = aes128-sha256-modp2048
        rekey_time = 14400s
    }
}

secrets {
    ike {
        id-vpns = vpns
        id-lotgW = lotgW
        secret = "your_secure_psk_password_here"
    }
}
```

```bash
# Load Configuration
sudo swanctl --load-all
sudo swanctl --list-conns
```
## LoT Gateway Configuration
Basic Settings
- Connection Mode: Always-on
- Remote Address: EC2 Elastic IP
- Local Address: LotgW Private IP

Security Settings
- Authentication: Pre-shared Key (PSK)
- Pre-shared Key: your_secure_psk_password_here (Must match EC2 configuration)
- Encryption: AES128
- Hash Algorithm: SHA256
- DH Group: 14 (modp2048)

Network Settings
- Local Subnet: your lotgW network
- Remote Subnet: your vpn network

NAT Traversal: 

## Firewall and Security Configuration
AWS Security Groups
Ensure your EC2 security group allows:
- UDP 500 (IKE)
- UDP 4500 (NAT-T)

CHECK Local Firewall

# Check iptables rules
```bash
sudo iptables -L -n

sudo iptables -A INPUT -p udp --dport 500 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 4500 -j ACCEPT
sudo iptables -A INPUT -p esp -j ACCEPT
```

## Testing and Validation
```bash
# Monitor Connection Status
# Check active connections
sudo swanctl --list-sas

# Monitor real-time logs
sudo swanctl --log

# Check system logs
sudo journalctl -u strongswan -f

# Test Connectivity
# Ping test through VPN
ping -I your lotgw private ip

# Test web interface access
curl http://your lotgw private ip

# Check routing table
ip route show
```

## Resources
- [StrongSwan Documentation](https://docs.strongswan.org/docs/latest/index.html)
- [AWS Security Groups Guide](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-groups.html)
- [オンプレから格安で閉域 AWS 環境に繋ぐため IPv6 対応 VPN Gateway 代わりの EC2 インスタンスを strongSwan で構築](https://qiita.com/takeda_h/items/eec8d43e7dd986fbcf87)

This comprehensive guide should help others successfully implement StrongSwan VPN connectivity between AWS EC2 and LoT Gateway devices. The solution addresses common challenges with mobile networks and provides a stable, secure connection for remote management.

